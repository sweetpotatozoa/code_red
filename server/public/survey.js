!function(){console.log("CatchTalk script loaded"),window.CatchTalk={activeSurveyId:null,currentStep:0,surveyResponseId:null,surveyResponses:[],surveys:[],environmentId:null};let s=new WeakMap;function i(e,t){localStorage.setItem("survey-"+e,JSON.stringify(t))}function o(e){if(!e.updateAt)return console.error(`Survey ${e._id}: Missing 'updateAt' field`),!1;if(!Array.isArray(e.triggers)||0===e.triggers.length)return console.error(`Survey ${e._id}: 'triggers' must be a non-empty array`),!1;if(!Array.isArray(e.steps)||0===e.steps.length)return console.error(`Survey ${e._id}: 'steps' must be a non-empty array`),!1;if(!e.delay||!e.delay.delayType)return console.error(`Survey ${e._id}: Missing 'delay.delayType' field`),!1;if("number"!=typeof e.delay.delayValue)return console.error(`Survey ${e._id}: 'delay.delayValue' must be a number`),!1;for(var t of e.steps){if(!t.id)return console.error(`Survey ${e._id}: Missing 'id' in step`),!1;if(void 0===t.title)return console.error(`Survey ${e._id}: Missing 'title' in step `+t.id),!1;if(void 0===t.description)return console.error(`Survey ${e._id}: Missing 'description' in step `+t.id),!1;switch(t.type){case"singleChoice":case"rating":if(!Array.isArray(t.options))return console.error(`Survey ${e._id}: 'options' must be an array in ${t.type} step `+t.id),!1;for(var r of t.options){if(!r.id)return console.error(`Survey ${e._id}: Missing 'id' in option of step `+t.id),!1;if(void 0===r.value)return console.error(`Survey ${e._id}: Missing 'value' in option ${r.id} of step `+t.id),!1;if(void 0===r.nextStepId)return console.error(`Survey ${e._id}: Missing 'nextStepId' in option ${r.id} of step `+t.id),!1}break;case"multipleChoice":if(!Array.isArray(t.options))return console.error(`Survey ${e._id}: 'options' must be an array in ${t.type} step `+t.id),!1;for(var a of t.options){if(!a.id)return console.error(`Survey ${e._id}: Missing 'id' in option of step `+t.id),!1;if(void 0===a.value)return console.error(`Survey ${e._id}: Missing 'value' in option ${a.id} of step `+t.id),!1}if(void 0===t.nextStepId)return console.error(`Survey ${e._id}: Missing 'nextStepId' in multipleChoice step `+t.id),!1;break;case"welcome":case"thank":case"link":case"freeText":case"info":if(void 0===t.nextStepId)return console.error(`Survey ${e._id}: Missing 'nextStepId' in step `+t.id),!1;break;default:return console.error(`Survey ${e._id}: Unknown step type '${t.type}' in step `+t.id),!1}}return!0}function t(e){var t=document.createElement("div"),r=(t.className="survey-step",document.createElement("div")),a=(r.className="survey-header",document.createElement("button")),n=(a.type="button",a.id="closeSurvey",a.className="close-button",document.createElement("img")),n=(n.src=CatchTalk.apiHost+"/images/close.svg",n.alt="close",n.className="close-icon",a.appendChild(n),r.appendChild(a),t.appendChild(r),document.createElement("div")),a=(n.className="content-wrapper",document.createElement("div")),r=(a.className="text-content",e.title&&((r=document.createElement("p")).className="survey-title",r.textContent=e.title,a.appendChild(r)),e.description&&((r=document.createElement("p")).className="survey-description",r.textContent=e.description,a.appendChild(r)),n.appendChild(a),l(e)),a=(r&&n.appendChild(r),c(e)),a=(a&&((r=document.createElement("div")).className="button-container",(e=document.createElement("button")).type="button",e.id="nextStepButton",e.className="submit-button",e.textContent=a,r.appendChild(e),n.appendChild(r)),t.appendChild(n),document.createElement("div")),e=(a.className="survey-progress",document.createElement("p")),r=(e.className="powered-by",e.innerHTML='Powered by <span class="logo">CatchTalk</span>',a.appendChild(e),document.createElement("div")),n=(r.className="background-bar",document.createElement("div"));return n.className="progress-bar",r.appendChild(n),a.appendChild(r),t.appendChild(a),t}function r(t,e){var r=document.querySelector(".progress-bar");r&&(e=(e.findIndex(e=>e.id===t)+1)/e.length*100,r.style.width=e+"%")}function c(e){switch(e.type){case"welcome":return"참여하기";case"link":return e.buttonText||"링크로 이동";case"thank":return"닫기";default:return"다음"}}function l(i){switch(i.type){case"singleChoice":case"multipleChoice":let n=document.createElement("div");return n.className="optionContainer",i.options.forEach(e=>{var t=document.createElement("label"),r=(t.className="optionLabel",document.createElement("input")),a=(r.type="singleChoice"===i.type?"radio":"checkbox",r.name=i.type,r.value=e.value,r.id=i.type+"-"+e.id,document.createElement("span"));a.textContent=e.value,t.appendChild(r),t.appendChild(a),n.appendChild(t)}),n;case"rating":let a=document.createElement("div");return a.className="starInputContainer",[...i.options].reverse().forEach(e=>{var t=document.createElement("label"),r=(t.className="starOptionLabel",document.createElement("input")),e=(r.type="radio",r.name="rating",r.value=e.value,r.id="rating-"+e.id,document.createElement("span"));e.className="star",e.textContent="★",t.appendChild(r),t.appendChild(e),a.appendChild(t)}),a;case"freeText":var e=document.createElement("textarea");return e.name="response",e.id="response",e.rows=4,e.cols=50,e.className="freeTextArea",e;default:return null}}function y(e){switch(e.type){case"welcome":return"clicked";case"singleChoice":var t=document.querySelector('input[name="singleChoice"]:checked');return t?{id:t.id.replace("singleChoice-",""),value:t.value}:null;case"multipleChoice":t=Array.from(document.querySelectorAll('input[name="multipleChoice"]:checked'));return 0<t.length?t.map(e=>({id:e.id.replace("multipleChoice-",""),value:e.value})):null;case"rating":t=document.querySelector(".starOptionLabel.checked");return t?{id:t.querySelector("input").id.replace("rating-",""),value:5-Array.from(t.parentNode.children).indexOf(t)}:null;case"freeText":t=document.getElementById("response");return t?t.value:"";case"link":case"info":return"clicked";default:return""}}function u(t,r){let a;return function(...e){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),t(...e)},r)}}Object.assign(CatchTalk,{getSurveyData:function(e){return(e=localStorage.getItem("survey-"+e))?JSON.parse(e):null},saveSurveyData:i,saveResponse:function(e,t){CatchTalk.surveyResponses.push({stepId:e.id,stepTitle:e.title,stepDescription:e.description,answer:t,type:e.type,timestamp:(new Date).toISOString()})},fetchSurvey:async function(e){try{var r=await fetch(CatchTalk.apiHost+`/api/appliedSurvey?userId=${e}&isDeploy=true`);if(!r.ok)throw new Error("Network response was not ok");var a=await r.json(),n=a.data.filter(o),i=await fetch(CatchTalk.apiHost+"/api/appliedSurvey/users/"+e);if(!i.ok)throw new Error("Network response was not ok");let t=(await i.json()).surveyPosition;return n.forEach(e=>{e.position=t}),{status:a.status,data:n}}catch(e){return console.error("Error fetching survey:",e),null}},createResponse:async function(e,t,r){try{var a=await fetch(CatchTalk.apiHost+"/api/appliedSurvey/response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,surveyId:t,answers:[r],createAt:r.timestamp,completeAt:null,isComplete:!1})});if(a.ok)return(await a.json()).data._id;throw new Error("HTTP error! status: "+a.status)}catch(e){throw console.error("Error in createResponse:",e),e}},updateResponse:async function(e,t,r){try{var a,n=await fetch(CatchTalk.apiHost+"/api/appliedSurvey/response/"+e,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({answers:t,completeAt:r?new Date:null,isComplete:r})});if(n.ok)return(a=JSON.parse(localStorage.getItem("survey-"+CatchTalk.activeSurveyId)))&&(a.completed=!0,i(CatchTalk.activeSurveyId,a)),n.json();throw new Error("HTTP error! status: "+n.status)}catch(e){throw console.error("Error in updateResponse:",e),e}},incrementViews:async function(e){try{await fetch(CatchTalk.apiHost+`/api/appliedSurvey/${e}/increment-views`,{method:"POST"})}catch(e){console.error("error in incrementViews:",e)}}}),CatchTalk.validateSurvey=o,Object.assign(CatchTalk,{canShowSurvey:function(e){if(!(t=CatchTalk.getSurveyData(e._id)))return!0;var{lastShownTime:t,completed:r}=t,a=(new Date-new Date(t))/1e3;switch(e.delay.delayType){case"once":return!1;case"untilCompleted":return r?!1:a>=e.delay.delayValue;case"always":return a>=e.delay.delayValue;default:return!1}},showStep:async function l(u,e){let d=u.steps.filter(e=>"welcome"!==e.type&&"thank"!==e.type||e.isActive),p=d[e];e=document.getElementById("survey-popup");if(p){if(e.innerHTML="",e.appendChild(t(p)),document.getElementById("closeSurvey").onclick=()=>{CatchTalk.closeSurvey(u._id,"thank"===p.type)},"singleChoice"===p.type||"multipleChoice"===p.type){let t=document.querySelectorAll(".optionLabel");t.forEach(e=>{e.querySelector("input").addEventListener("change",function(){"singleChoice"===p.type&&t.forEach(e=>e.classList.remove("checked")),this.checked?e.classList.add("checked"):e.classList.remove("checked")})})}if((e=document.getElementById("nextStepButton"))&&("thank"===p.type?e.onclick=()=>CatchTalk.closeSurvey(u._id,!0):e.onclick=async function(a){if(a.preventDefault(),null!==(a=y(p))){CatchTalk.saveResponse(p,a);try{if(CatchTalk.surveyResponseId?await CatchTalk.updateResponse(CatchTalk.surveyResponseId,CatchTalk.surveyResponses,!1):CatchTalk.surveyResponseId=await CatchTalk.createResponse(CatchTalk.environmentId,u._id,{...CatchTalk.surveyResponses[0]}),"link"===p.type){if(!p.url)return void console.error("Missing URL in link step");window.open(p.url.startsWith("http")?p.url:"https://"+p.url,"_blank")}let r;if("singleChoice"===p.type||"rating"===p.type){let t=a.id;var n=p.options.find(e=>e.id===t);r=n?n.nextStepId:null}else r=p.nextStepId;var t,i,s,o,c=u.steps.find(e=>"thank"===e.type);let e=!1;c&&(""===r||null===r?(t=d.findIndex(e=>e.id===p.id),((i=d[t+1])&&"thank"===i.type||!i)&&(e=!0)):r===c.id&&(e=!0)),await CatchTalk.updateResponse(CatchTalk.surveyResponseId,CatchTalk.surveyResponses,e),r&&""!==r?-1!==(s=d.findIndex(e=>e.id===r))?l(u,s):CatchTalk.closeSurvey(u._id,e):(o=d.findIndex(e=>e.id===p.id))<d.length-1?l(u,o+1):CatchTalk.closeSurvey(u._id,e)}catch(e){console.error("Error while submitting survey:",e)}}}),"rating"===p.type&&(e=document.querySelector(".starInputContainer"))){let t=e.querySelectorAll(".starOptionLabel");t.forEach((e,r)=>{e.addEventListener("click",()=>{t.forEach((e,t)=>{r<=t?e.classList.add("checked"):e.classList.remove("checked")})})})}r(p.id,u.steps)}else CatchTalk.closeSurvey(u._id,!1)},closeSurvey:function(e,t=!1){var r=document.getElementById("survey-popup");r&&r.remove(),CatchTalk.activeSurveyId=null,window.dispatchEvent(new Event("surveyCompleted")),CatchTalk.surveyResponseId&&CatchTalk.updateResponse(CatchTalk.surveyResponseId,CatchTalk.surveyResponses,t)},generateStepHTML:t,updateProgressBar:r,getButtonText:c,generateStepContent:l,getResponse:y});let d=u(e=>{for(var t of e)if(null===CatchTalk.activeSurveyId&&CatchTalk.canShowSurvey(t)){CatchTalk.loadSurvey(t);break}},200);function p(){let r=new URL(window.location.href);CatchTalk.surveys.forEach(t=>{t.triggers.forEach(e=>{"url"===e.type&&("#checkConnection"===e.url?"#checkConnection"===r.hash&&d([t]):(e=new URL(e.url,window.location.origin),(r.pathname===e.pathname||"/"===r.pathname&&""===e.pathname)&&d([t])))})})}function h(e){return"all"===e.pageType||"specific"===e.pageType&&new URL(window.location.href).pathname===e.pageValue}function v(n,e,i){e.forEach(([t,r])=>{let a=JSON.parse(t);if("click"===a.type&&h(a))if("css"===a.clickType){t=a.clickValue.trim().split(/\s+/).map(e=>e.startsWith("#")?"#"+CSS.escape(e.slice(1)):e.startsWith(".")?"."+CSS.escape(e.slice(1)):"."+CSS.escape(e)).join("");try{if(n.matches(t)&&!s.has(n)){let e=()=>d(r);n.addEventListener("click",e),s.set(n,!0),console.log("Click trigger set for "+a.clickValue),i.set(n,()=>{n.removeEventListener("click",e),s.delete(n)})}}catch(e){console.error("Invalid selector: "+t,e)}}else"text"===a.clickType&&function(e){let t=[],r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),a;for(;a=r.nextNode();)t.push(a);return t}(n).forEach(e=>{if(e.textContent.trim()===a.clickValue){let t=e.parentElement;if(!s.has(t)){let e=e=>{e.target.textContent.trim()===a.clickValue&&d(r)};t.addEventListener("click",e),s.set(t,!0),i.set(t,()=>{t.removeEventListener("click",e),s.delete(t)})}}})})}"function"!=typeof CSS.escape&&(CSS.escape=function(e){return String(e).replace(/[\0-\x1F\x7F-\x9F\xA0\xAD\u0600-\u0604\u070F\u17B4\u17B5\u2000-\u200F\u2028-\u202F\u2060-\u206F\uFEFF\uFFF0-\uFFF8\uD800-\uF8FF\uFDD0-\uFDEF\uFFFE\uFFFF]/g,function(e){return"\\"+e.charCodeAt(0).toString(16)+" "}).replace(/[\s\S]/g,function(e){switch(e){case" ":case'"':case"#":case"$":case"%":case"&":case"'":case"(":case")":case"*":case"+":case",":case".":case"/":case";":case"<":case"=":case">":case"?":case"@":case"[":case"\\":case"]":case"^":case"`":case"{":case"|":case"}":case"~":return"\\"+e;default:return e}})}),Object.assign(CatchTalk,{setupTriggers:function(e){CatchTalk.surveys=e;let n=new Map,i={firstVisit:1,url:2,exit:3,scroll:4,click:5},t=(CatchTalk.surveys.forEach(a=>{a.triggers.forEach(e=>{var t,r,e=JSON.stringify({...e,priority:i[e.type]});n.has(e)?-1===(r=(t=n.get(e)).findIndex(e=>new Date(a.updateAt)>new Date(e.updateAt)))?t.push(a):t.splice(r,0,a):n.set(e,[a])})}),Array.from(n.entries()).sort((e,t)=>{var r=JSON.parse(e[0]),a=JSON.parse(t[0]);return r.priority===a.priority?new Date(n.get(t[0])[0].updateAt)-new Date(n.get(e[0])[0].updateAt):r.priority-a.priority})),a=new Map;try{new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"class"===e.attributeName?v(e.target,t,a):"childList"===e.type&&e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(v(e,t,a),e.querySelectorAll("*").forEach(e=>v(e,t,a)))})})}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),document.querySelectorAll("*").forEach(e=>v(e,t,a)),t.forEach(([e,t])=>{e=JSON.parse(e);if("exit"===e.type&&h(e)){let e=e=>{e.clientY<=0&&d(t)};document.addEventListener("mouseleave",e),console.log("Exit trigger set"),a.set("mouseleave",()=>document.removeEventListener("mouseleave",e))}if("firstVisit"===e.type&&h(e)&&(d(t),console.log("First Visit trigger set")),"url"===e.type){{var r=p;let e=history.pushState,t=history.replaceState;history.pushState=function(){e.apply(this,arguments),r()},history.replaceState=function(){t.apply(this,arguments),r()},window.addEventListener("popstate",r)}p(),console.log("URL trigger set for "+e.url)}if("scroll"===e.type&&h(e)){let e=u(()=>{.01<=(window.scrollY+window.innerHeight)/document.body.scrollHeight&&d(t)},200);window.addEventListener("scroll",e),console.log("Scroll trigger set"),a.set("scroll",()=>window.removeEventListener("scroll",e))}})}catch(e){console.error("Error in setupTriggers:",e)}return()=>{a.forEach(e=>e()),a.clear()}},loadSurvey:function(t){var e;null===CatchTalk.activeSurveyId&&(CatchTalk.activeSurveyId=t._id,CatchTalk.currentStep=0,CatchTalk.surveyResponses=[],(e=document.createElement("link")).rel="stylesheet",e.type="text/css",e.href=CatchTalk.apiHost+"/survey.css",document.head.appendChild(e),e.onload=async()=>{var e=document.createElement("div");e.id="survey-popup",e.classList.add("survey-popup-position-"+t.position),document.body.appendChild(e),await CatchTalk.incrementViews(t._id),CatchTalk.showStep(t,CatchTalk.currentStep),CatchTalk.saveSurveyData(t._id,{lastShownTime:(new Date).toISOString(),completed:!1})})},handleUrlChange:p,isCorrectPage:h}),CatchTalk.init=async function(e){if(!e||!e.environmentId)throw new Error("Environment ID is required in the configuration");CatchTalk.environmentId=e.environmentId,CatchTalk.apiHost=e.apiHost;try{var r=await CatchTalk.fetchSurvey(CatchTalk.environmentId);if(r){let t=CatchTalk.setupTriggers(r.data);window.addEventListener("beforeunload",()=>t(CatchTalk.activeSurveyId)),window.addEventListener("surveyCompleted",function e(){t(CatchTalk.activeSurveyId),window.removeEventListener("surveyCompleted",e)})}}catch(e){console.error("Error initializing survey script:",e)}},"complete"===document.readyState?console.log("CatchTalk script is ready to be initialized"):window.addEventListener("load",function(){console.log("CatchTalk script is ready to be initialized")})}();