!async function(){let u="https://port-0-codered-ss7z32llwexb5xe.sel5.cloudtype.app",n=(window.activeSurveyId=null,0),p=null,m=[],c=[],i=new WeakMap;function s(e,t){localStorage.setItem("survey-"+e,JSON.stringify(t))}async function y(e,t,n){try{var r,a=await fetch(u+"/api/appliedSurvey/response/"+e,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({answers:t,completeAt:n?new Date:null,isComplete:n})});if(a.ok)return(r=JSON.parse(localStorage.getItem("survey-"+window.activeSurveyId)))&&(r.completed=!0,s(window.activeSurveyId,r)),a.json();throw new Error("HTTP error! status: "+a.status)}catch(e){throw e}}function o(e){if(!e.updateAt)return!1;if(!Array.isArray(e.triggers)||0===e.triggers.length)return!1;if(!Array.isArray(e.steps)||0===e.steps.length)return!1;if(!e.delay||!e.delay.delayType)return!1;if("number"!=typeof e.delay.delayValue)return!1;for(var t of e.steps){if(!t.id)return!1;if(void 0===t.title)return!1;if(void 0===t.description)return!1;switch(t.type){case"singleChoice":case"rating":if(!Array.isArray(t.options))return!1;for(var n of t.options){if(!n.id)return!1;if(void 0===n.value)return!1;if(void 0===n.nextStepId)return!1}break;case"multipleChoice":if(!Array.isArray(t.options))return!1;for(var r of t.options){if(!r.id)return!1;if(void 0===r.value)return!1}if(void 0===t.nextStepId)return!1;break;case"welcome":case"thank":case"link":case"freeText":case"info":if(void 0===t.nextStepId)return!1;break;default:return!1}}return!0}function r(e){t=e._id;var t=(t=localStorage.getItem("survey-"+t))?JSON.parse(t):null;if(!t)return 1;var{lastShownTime:t,completed:n}=t,r=(new Date-new Date(t))/1e3;switch(e.delay.delayType){case"once":return;case"untilCompleted":return n?void 0:r>=e.delay.delayValue;case"always":return r>=e.delay.delayValue;default:return}}async function h(s,o){let l=s.steps.filter(e=>"welcome"!==e.type&&"thank"!==e.type||e.isActive),d=l[o];var e=document.getElementById("survey-popup");if(d){if(e.innerHTML="",e.appendChild(function(e){var t=document.createElement("div"),n=(t.className="survey-step",document.createElement("div")),r=(n.className="survey-header",document.createElement("button")),a=(r.type="button",r.id="closeSurvey",r.className="close-button",document.createElement("img")),a=(a.src=u+"/images/close.svg",a.alt="close",a.className="close-icon",r.appendChild(a),n.appendChild(r),t.appendChild(n),document.createElement("div")),r=(a.className="content-wrapper",document.createElement("div"));r.className="text-content",e.title&&((n=document.createElement("p")).className="survey-title",n.textContent=e.title,r.appendChild(n));e.description&&((n=document.createElement("p")).className="survey-description",n.textContent=e.description,r.appendChild(n));a.appendChild(r);n=function(i){switch(i.type){case"singleChoice":case"multipleChoice":let a=document.createElement("div");return a.className="optionContainer",i.options.forEach(e=>{var t=document.createElement("label"),n=(t.className="optionLabel",document.createElement("input")),r=(n.type="singleChoice"===i.type?"radio":"checkbox",n.name=i.type,n.value=e.value,n.id=i.type+"-"+e.id,document.createElement("span"));r.textContent=e.value,t.appendChild(n),t.appendChild(r),a.appendChild(t)}),a;case"rating":let r=document.createElement("div");return r.className="starInputContainer",[...i.options].reverse().forEach(e=>{var t=document.createElement("label"),n=(t.className="starOptionLabel",document.createElement("input")),e=(n.type="radio",n.name="rating",n.value=e.value,n.id="rating-"+e.id,document.createElement("span"));e.className="star",e.textContent="★",t.appendChild(n),t.appendChild(e),r.appendChild(t)}),r;case"freeText":var e=document.createElement("textarea");return e.name="response",e.id="response",e.rows=4,e.cols=50,e.className="freeTextArea",e;default:return null}}(e);n&&a.appendChild(n);r=function(e){switch(e.type){case"welcome":return"참여하기";case"link":return e.buttonText||"링크로 이동";case"thank":return"닫기";default:return"다음"}}(e);r&&((n=document.createElement("div")).className="button-container",(e=document.createElement("button")).type="button",e.id="nextStepButton",e.className="submit-button",e.textContent=r,n.appendChild(e),a.appendChild(n));t.appendChild(a);r=document.createElement("div"),r.className="survey-progress",e=document.createElement("p"),e.className="powered-by",e.innerHTML='Powered by <span class="logo">CatchTalk</span>',r.appendChild(e),n=document.createElement("div"),n.className="background-bar",a=document.createElement("div");return a.className="progress-bar",n.appendChild(a),r.appendChild(n),t.appendChild(r),t}(d)),document.getElementById("closeSurvey").onclick=()=>{f(s._id,"thank"===d.type)},"singleChoice"===d.type||"multipleChoice"===d.type){let t=document.querySelectorAll(".optionLabel");t.forEach(e=>{e.querySelector("input").addEventListener("change",function(){"singleChoice"===d.type&&t.forEach(e=>e.classList.remove("checked")),this.checked?e.classList.add("checked"):e.classList.remove("checked")})})}var t,n,e=document.getElementById("nextStepButton");if(e&&("thank"===d.type?e.onclick=()=>f(s._id,!0):e.onclick=async function(r){r.preventDefault();var e,t,a,i,r=function(e){switch(e.type){case"welcome":return"clicked";case"singleChoice":var t=document.querySelector('input[name="singleChoice"]:checked');return t?{id:t.id.replace("singleChoice-",""),value:t.value}:null;case"multipleChoice":t=Array.from(document.querySelectorAll('input[name="multipleChoice"]:checked'));return 0<t.length?t.map(e=>({id:e.id.replace("multipleChoice-",""),value:e.value})):null;case"rating":var n=document.querySelector(".starOptionLabel.checked");return n?{id:n.querySelector("input").id.replace("rating-",""),value:5-Array.from(n.parentNode.children).indexOf(n)}:null;case"freeText":n=document.getElementById("response");return n?n.value:"";case"link":case"info":return"clicked";default:return""}}(d);if(null!==r){e=d,t=r,m.push({stepId:e.id,stepTitle:e.title,stepDescription:e.description,answer:t,type:e.type,timestamp:(new Date).toISOString()});try{if(p?await y(p,m,!1):p=await async function(e,t,n){try{var r=await fetch(u+"/api/appliedSurvey/response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,surveyId:t,answers:[n],createAt:n.timestamp,completeAt:null,isComplete:!1})});if(r.ok)return(await r.json()).data._id;throw new Error("HTTP error! status: "+r.status)}catch(e){throw e}}(s.userId,s._id,{...m[0]}),"link"===d.type){if(!d.url)return;window.open(d.url.startsWith("http")?d.url:"https://"+d.url,"_blank")}let n;if("singleChoice"===d.type||"rating"===d.type){let t=r.id;var c=d.options.find(e=>e.id===t);n=c?c.nextStepId:null}else n=d.nextStepId;let e,t=((!n||""===n||-1===(e=s.steps.findIndex(e=>e.id===n)))&&(e=o+1),!1);if((t=e>=l.length||"thank"===(a=s.steps[e]).type&&a.isActive?!0:t)&&await y(p,m,!0),e<l.length)h(s,e);else{let t=s.steps.find(e=>"thank"===e.type&&e.isActive);t?(i=s.steps.findIndex(e=>e.id===t.id),h(s,i)):f(s._id,!0)}}catch(e){}}}),"rating"===d.type){e=document.querySelector(".starInputContainer");if(e){let t=e.querySelectorAll(".starOptionLabel");t.forEach((e,n)=>{e.addEventListener("click",()=>{t.forEach((e,t)=>{n<=t?e.classList.add("checked"):e.classList.remove("checked")})})})}}t=d.id,e=s.steps,(n=document.querySelector(".progress-bar"))&&(e=(e.findIndex(e=>e.id===t)+1)/e.length*100,n.style.width=e+"%")}else f(s._id,!1)}function f(e,t=!1){var n=document.getElementById("survey-popup");n&&n.remove(),window.activeSurveyId=null,window.dispatchEvent(new Event("surveyCompleted")),p&&y(p,m,t)}function l(t,n){let r;return function(...e){clearTimeout(r),r=setTimeout(()=>{clearTimeout(r),t(...e)},n)}}let d=l(e=>{for(var t of e)if(null===window.activeSurveyId&&r(t)){!function(t){var e;null===window.activeSurveyId&&(window.activeSurveyId=t._id,n=0,m=[],(e=document.createElement("link")).rel="stylesheet",e.type="text/css",e.href=u+"/survey.css",document.head.appendChild(e),e.onload=async()=>{var e=document.createElement("div"),e=(e.id="survey-popup",e.classList.add("survey-popup-position-"+t.position),document.body.appendChild(e),t._id);try{await fetch(u+`/api/appliedSurvey/${e}/increment-views`,{method:"POST"})}catch(e){}await 0,h(t,n),s(t._id,{lastShownTime:(new Date).toISOString(),completed:!1})})}(t);break}},200);function v(){let n=new URL(window.location.href);c.forEach(t=>{t.triggers.forEach(e=>{"url"===e.type&&("#checkConnection"===e.url?"#checkConnection"===n.hash&&d([t]):(e=new URL(e.url,window.location.origin),(n.pathname===e.pathname||"/"===n.pathname&&""===e.pathname)&&d([t])))})})}function w(e){return"all"===e.pageType||"specific"===e.pageType&&new URL(window.location.href).pathname===e.pageValue}function a(e){c=e;let a=new Map,i={firstVisit:1,url:2,exit:3,scroll:4,click:5},t=(c.forEach(r=>{r.triggers.forEach(e=>{var t,n,e=JSON.stringify({...e,priority:i[e.type]});a.has(e)?-1===(n=(t=a.get(e)).findIndex(e=>new Date(r.updateAt)>new Date(e.updateAt)))?t.push(r):t.splice(n,0,r):a.set(e,[r])})}),Array.from(a.entries()).sort((e,t)=>{var n=JSON.parse(e[0]),r=JSON.parse(t[0]);return n.priority===r.priority?new Date(a.get(t[0])[0].updateAt)-new Date(a.get(e[0])[0].updateAt):n.priority-r.priority})),r=new Map;try{new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"class"===e.attributeName?E(e.target,t,r):"childList"===e.type&&e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(E(e,t,r),e.querySelectorAll("*").forEach(e=>E(e,t,r)))})})}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),document.querySelectorAll("*").forEach(e=>E(e,t,r)),t.forEach(([e,t])=>{e=JSON.parse(e);if("exit"===e.type&&w(e)){let e=e=>{e.clientY<=0&&d(t)};document.addEventListener("mouseleave",e),r.set("mouseleave",()=>document.removeEventListener("mouseleave",e))}if("firstVisit"===e.type&&w(e)&&d(t),"url"===e.type){{var n=v;let e=history.pushState,t=history.replaceState;history.pushState=function(){e.apply(this,arguments),n()},history.replaceState=function(){t.apply(this,arguments),n()},window.addEventListener("popstate",n)}v()}if("scroll"===e.type&&w(e)){let e=l(()=>{.01<=(window.scrollY+window.innerHeight)/document.body.scrollHeight&&d(t)},200);window.addEventListener("scroll",e),r.set("scroll",()=>window.removeEventListener("scroll",e))}})}catch(e){}return()=>{r.forEach(e=>e()),r.clear()}}function E(t,e,a){e.forEach(([e,n])=>{let r=JSON.parse(e);if("click"===r.type&&w(r))if("css"===r.clickType){e=r.clickValue.trim().split(/\s+/).map(e=>e.startsWith("#")?"#"+CSS.escape(e.slice(1)):e.startsWith(".")?"."+CSS.escape(e.slice(1)):"."+CSS.escape(e)).join("");try{if(t.matches(e)&&!i.has(t)){let e=()=>d(n);t.addEventListener("click",e),i.set(t,!0),a.set(t,()=>{t.removeEventListener("click",e),i.delete(t)})}}catch(e){}}else"text"===r.clickType&&function(e){let t=[],n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),r;for(;r=n.nextNode();)t.push(r);return t}(t).forEach(e=>{if(e.textContent.trim()===r.clickValue){let t=e.parentElement;if(!i.has(t)){let e=e=>{e.target.textContent.trim()===r.clickValue&&d(n)};t.addEventListener("click",e),i.set(t,!0),a.set(t,()=>{t.removeEventListener("click",e),i.delete(t)})}}})})}"function"!=typeof CSS.escape&&(CSS.escape=function(e){return String(e).replace(/[\0-\x1F\x7F-\x9F\xA0\xAD\u0600-\u0604\u070F\u17B4\u17B5\u2000-\u200F\u2028-\u202F\u2060-\u206F\uFEFF\uFFF0-\uFFF8\uD800-\uF8FF\uFDD0-\uFDEF\uFFFE\uFFFF]/g,function(e){return"\\"+e.charCodeAt(0).toString(16)+" "}).replace(/[\s\S]/g,function(e){switch(e){case" ":case'"':case"#":case"$":case"%":case"&":case"'":case"(":case")":case"*":case"+":case",":case".":case"/":case";":case"<":case"=":case">":case"?":case"@":case"[":case"\\":case"]":case"^":case"`":case"{":case"|":case"}":case"~":return"\\"+e;default:return e}})}),async function(){var e=function(){var e;for(e of document.getElementsByTagName("script")){var t=e.src.match(/userId=([0-9a-fA-F]{24})/);if(t)return t[1]}return null}();if(!e)throw new Error("User ID is not provided in the URL");try{var n=await async function(e){try{var n=await fetch(u+`/api/appliedSurvey?userId=${e}&isDeploy=true`);if(!n.ok)throw new Error("Network response was not ok");var r=await n.json(),a=r.data.filter(o),i=await fetch(u+"/api/appliedSurvey/users/"+e);if(!i.ok)throw new Error("Network response was not ok");let t=(await i.json()).surveyPosition;return a.forEach(e=>{e.position=t}),{status:r.status,data:a}}catch(e){return null}}(e);if(n){let t=a(n.data);window.addEventListener("beforeunload",()=>t(window.activeSurveyId)),window.addEventListener("surveyCompleted",function e(){t(window.activeSurveyId),window.removeEventListener("surveyCompleted",e)})}}catch(e){}}()}();