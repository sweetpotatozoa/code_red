!async function(){console.log("CatchTalk script loaded");let u="https://port-0-codered-ss7z32llwexb5xe.sel5.cloudtype.app",r=(window.activeSurveyId=null,0),p=null,y=[],o=[],s=new WeakMap;function a(e,t){localStorage.setItem("survey-"+e,JSON.stringify(t))}async function m(e,t,r){try{var n,i=await fetch(u+"/api/appliedSurvey/response/"+e,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({answers:t,completeAt:r?new Date:null,isComplete:r})});if(i.ok)return(n=JSON.parse(localStorage.getItem("survey-"+window.activeSurveyId)))&&(n.completed=!0,a(window.activeSurveyId,n)),i.json();throw new Error("HTTP error! status: "+i.status)}catch(e){throw console.error("Error in updateResponse:",e),e}}function c(e){if(!e.updateAt)return console.error(`Survey ${e._id}: Missing 'updateAt' field`),!1;if(!Array.isArray(e.triggers)||0===e.triggers.length)return console.error(`Survey ${e._id}: 'triggers' must be a non-empty array`),!1;if(!Array.isArray(e.steps)||0===e.steps.length)return console.error(`Survey ${e._id}: 'steps' must be a non-empty array`),!1;if(!e.delay||!e.delay.delayType)return console.error(`Survey ${e._id}: Missing 'delay.delayType' field`),!1;if("number"!=typeof e.delay.delayValue)return console.error(`Survey ${e._id}: 'delay.delayValue' must be a number`),!1;for(var t of e.steps){if(!t.id)return console.error(`Survey ${e._id}: Missing 'id' in step`),!1;if(void 0===t.title)return console.error(`Survey ${e._id}: Missing 'title' in step `+t.id),!1;if(void 0===t.description)return console.error(`Survey ${e._id}: Missing 'description' in step `+t.id),!1;switch(t.type){case"singleChoice":case"rating":if(!Array.isArray(t.options))return console.error(`Survey ${e._id}: 'options' must be an array in ${t.type} step `+t.id),!1;for(var r of t.options){if(!r.id)return console.error(`Survey ${e._id}: Missing 'id' in option of step `+t.id),!1;if(void 0===r.value)return console.error(`Survey ${e._id}: Missing 'value' in option ${r.id} of step `+t.id),!1;if(void 0===r.nextStepId)return console.error(`Survey ${e._id}: Missing 'nextStepId' in option ${r.id} of step `+t.id),!1}break;case"multipleChoice":if(!Array.isArray(t.options))return console.error(`Survey ${e._id}: 'options' must be an array in ${t.type} step `+t.id),!1;for(var n of t.options){if(!n.id)return console.error(`Survey ${e._id}: Missing 'id' in option of step `+t.id),!1;if(void 0===n.value)return console.error(`Survey ${e._id}: Missing 'value' in option ${n.id} of step `+t.id),!1}if(void 0===t.nextStepId)return console.error(`Survey ${e._id}: Missing 'nextStepId' in multipleChoice step `+t.id),!1;break;case"welcome":case"thank":case"link":case"freeText":case"info":if(void 0===t.nextStepId)return console.error(`Survey ${e._id}: Missing 'nextStepId' in step `+t.id),!1;break;default:return console.error(`Survey ${e._id}: Unknown step type '${t.type}' in step `+t.id),!1}}return!0}function n(e){t=e._id;var t=(t=localStorage.getItem("survey-"+t))?JSON.parse(t):null;if(!t)return 1;var{lastShownTime:t,completed:r}=t,n=(new Date-new Date(t))/1e3;switch(e.delay.delayType){case"once":return;case"untilCompleted":return r?void 0:n>=e.delay.delayValue;case"always":return n>=e.delay.delayValue;default:return}}async function v(s,c){let l=s.steps.filter(e=>"welcome"!==e.type&&"thank"!==e.type||e.isActive),d=l[c];var e=document.getElementById("survey-popup");if(d){if(e.innerHTML="",e.appendChild(function(e){var t=document.createElement("div"),r=(t.className="survey-step",document.createElement("div")),n=(r.className="survey-header",document.createElement("button")),i=(n.type="button",n.id="closeSurvey",n.className="close-button",document.createElement("img")),i=(i.src=u+"/images/close.svg",i.alt="close",i.className="close-icon",n.appendChild(i),r.appendChild(n),t.appendChild(r),document.createElement("div")),n=(i.className="content-wrapper",document.createElement("div"));n.className="text-content",e.title&&((r=document.createElement("p")).className="survey-title",r.textContent=e.title,n.appendChild(r));e.description&&((r=document.createElement("p")).className="survey-description",r.textContent=e.description,n.appendChild(r));i.appendChild(n);r=function(a){switch(a.type){case"singleChoice":case"multipleChoice":let i=document.createElement("div");return i.className="optionContainer",a.options.forEach(e=>{var t=document.createElement("label"),r=(t.className="optionLabel",document.createElement("input")),n=(r.type="singleChoice"===a.type?"radio":"checkbox",r.name=a.type,r.value=e.value,r.id=a.type+"-"+e.id,document.createElement("span"));n.textContent=e.value,t.appendChild(r),t.appendChild(n),i.appendChild(t)}),i;case"rating":let n=document.createElement("div");return n.className="starInputContainer",[...a.options].reverse().forEach(e=>{var t=document.createElement("label"),r=(t.className="starOptionLabel",document.createElement("input")),e=(r.type="radio",r.name="rating",r.value=e.value,r.id="rating-"+e.id,document.createElement("span"));e.className="star",e.textContent="★",t.appendChild(r),t.appendChild(e),n.appendChild(t)}),n;case"freeText":var e=document.createElement("textarea");return e.name="response",e.id="response",e.rows=4,e.cols=50,e.className="freeTextArea",e;default:return null}}(e);r&&i.appendChild(r);n=function(e){switch(e.type){case"welcome":return"참여하기";case"link":return e.buttonText||"링크로 이동";case"thank":return"닫기";default:return"다음"}}(e);n&&((r=document.createElement("div")).className="button-container",(e=document.createElement("button")).type="button",e.id="nextStepButton",e.className="submit-button",e.textContent=n,r.appendChild(e),i.appendChild(r));t.appendChild(i);n=document.createElement("div"),n.className="survey-progress",e=document.createElement("p"),e.className="powered-by",e.innerHTML='Powered by <span class="logo">CatchTalk</span>',n.appendChild(e),r=document.createElement("div"),r.className="background-bar",i=document.createElement("div");return i.className="progress-bar",r.appendChild(i),n.appendChild(r),t.appendChild(n),t}(d)),document.getElementById("closeSurvey").onclick=()=>{h(s._id,"thank"===d.type)},"singleChoice"===d.type||"multipleChoice"===d.type){let t=document.querySelectorAll(".optionLabel");t.forEach(e=>{e.querySelector("input").addEventListener("change",function(){"singleChoice"===d.type&&t.forEach(e=>e.classList.remove("checked")),this.checked?e.classList.add("checked"):e.classList.remove("checked")})})}var t,r,e=document.getElementById("nextStepButton");if(e&&("thank"===d.type?e.onclick=()=>h(s._id,!0):e.onclick=async function(n){n.preventDefault();var e,t,i,a,n=function(e){switch(e.type){case"welcome":return"clicked";case"singleChoice":var t=document.querySelector('input[name="singleChoice"]:checked');return t?{id:t.id.replace("singleChoice-",""),value:t.value}:null;case"multipleChoice":t=Array.from(document.querySelectorAll('input[name="multipleChoice"]:checked'));return 0<t.length?t.map(e=>({id:e.id.replace("multipleChoice-",""),value:e.value})):null;case"rating":var r=document.querySelector(".starOptionLabel.checked");return r?{id:r.querySelector("input").id.replace("rating-",""),value:5-Array.from(r.parentNode.children).indexOf(r)}:null;case"freeText":r=document.getElementById("response");return r?r.value:"";case"link":case"info":return"clicked";default:return""}}(d);if(null!==n){e=d,t=n,y.push({stepId:e.id,stepTitle:e.title,stepDescription:e.description,answer:t,type:e.type,timestamp:(new Date).toISOString()});try{if(p?await m(p,y,!1):p=await async function(e,t,r){try{var n=await fetch(u+"/api/appliedSurvey/response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,surveyId:t,answers:[r],createAt:r.timestamp,completeAt:null,isComplete:!1})});if(n.ok)return(await n.json()).data._id;throw new Error("HTTP error! status: "+n.status)}catch(e){throw console.error("Error in createResponse:",e),e}}(s.userId,s._id,{...y[0]}),"link"===d.type){if(!d.url)return void console.error("링크 URL이 존재하지 않습니다.");window.open(d.url.startsWith("http")?d.url:"https://"+d.url,"_blank")}let r;if("singleChoice"===d.type||"rating"===d.type){let t=n.id;var o=d.options.find(e=>e.id===t);r=o?o.nextStepId:null}else r=d.nextStepId;let e,t=((!r||""===r||-1===(e=s.steps.findIndex(e=>e.id===r)))&&(e=c+1),!1);if((t=e>=l.length||"thank"===(i=s.steps[e]).type&&i.isActive?!0:t)&&await m(p,y,!0),e<l.length)v(s,e);else{let t=s.steps.find(e=>"thank"===e.type&&e.isActive);t?(a=s.steps.findIndex(e=>e.id===t.id),v(s,a)):h(s._id,!0)}}catch(e){console.error("Error while submitting survey:",e)}}}),"rating"===d.type){e=document.querySelector(".starInputContainer");if(e){let t=e.querySelectorAll(".starOptionLabel");t.forEach((e,r)=>{e.addEventListener("click",()=>{t.forEach((e,t)=>{r<=t?e.classList.add("checked"):e.classList.remove("checked")})})})}}t=d.id,e=s.steps,(r=document.querySelector(".progress-bar"))&&(e=(e.findIndex(e=>e.id===t)+1)/e.length*100,r.style.width=e+"%")}else h(s._id,!1)}function h(e,t=!1){var r=document.getElementById("survey-popup");r&&r.remove(),window.activeSurveyId=null,window.dispatchEvent(new Event("surveyCompleted")),p&&m(p,y,t)}function l(t,r){let n;return function(...e){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),t(...e)},r)}}let d=l(e=>{for(var t of e)if(null===window.activeSurveyId&&n(t)){!function(t){var e;null===window.activeSurveyId&&(window.activeSurveyId=t._id,r=0,y=[],(e=document.createElement("link")).rel="stylesheet",e.type="text/css",e.href=u+"/survey.css",document.head.appendChild(e),e.onload=async()=>{var e=document.createElement("div"),e=(e.id="survey-popup",e.classList.add("survey-popup-position-"+t.position),document.body.appendChild(e),t._id);try{await fetch(u+`/api/appliedSurvey/${e}/increment-views`,{method:"POST"})}catch(e){console.error("노출 카운트 증가 중 오류 발생:",e)}await 0,v(t,r),a(t._id,{lastShownTime:(new Date).toISOString(),completed:!1})})}(t);break}},200);function f(){let r=new URL(window.location.href);o.forEach(t=>{t.triggers.forEach(e=>{"url"===e.type&&("#checkConnection"===e.url?"#checkConnection"===r.hash&&d([t]):(e=new URL(e.url,window.location.origin),(r.pathname===e.pathname||"/"===r.pathname&&""===e.pathname)&&d([t])))})})}function w(e){return"all"===e.pageType||"specific"===e.pageType&&new URL(window.location.href).pathname===e.pageValue}function i(e){o=e;let i=new Map,a={firstVisit:1,url:2,exit:3,scroll:4,click:5},t=(o.forEach(n=>{n.triggers.forEach(e=>{var t,r,e=JSON.stringify({...e,priority:a[e.type]});i.has(e)?-1===(r=(t=i.get(e)).findIndex(e=>new Date(n.updateAt)>new Date(e.updateAt)))?t.push(n):t.splice(r,0,n):i.set(e,[n])})}),Array.from(i.entries()).sort((e,t)=>{var r=JSON.parse(e[0]),n=JSON.parse(t[0]);return r.priority===n.priority?new Date(i.get(t[0])[0].updateAt)-new Date(i.get(e[0])[0].updateAt):r.priority-n.priority})),n=new Map;try{new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"class"===e.attributeName?g(e.target,t,n):"childList"===e.type&&e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(g(e,t,n),e.querySelectorAll("*").forEach(e=>g(e,t,n)))})})}).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),document.querySelectorAll("*").forEach(e=>g(e,t,n)),t.forEach(([e,t])=>{e=JSON.parse(e);if("exit"===e.type&&w(e)){let e=e=>{e.clientY<=0&&d(t)};document.addEventListener("mouseleave",e),console.log("Exit trigger set"),n.set("mouseleave",()=>document.removeEventListener("mouseleave",e))}if("firstVisit"===e.type&&w(e)&&(d(t),console.log("First Visit trigger set")),"url"===e.type){{var r=f;let e=history.pushState,t=history.replaceState;history.pushState=function(){e.apply(this,arguments),r()},history.replaceState=function(){t.apply(this,arguments),r()},window.addEventListener("popstate",r)}f(),console.log("URL trigger set for "+e.url)}if("scroll"===e.type&&w(e)){let e=l(()=>{.01<=(window.scrollY+window.innerHeight)/document.body.scrollHeight&&d(t)},200);window.addEventListener("scroll",e),console.log("Scroll trigger set"),n.set("scroll",()=>window.removeEventListener("scroll",e))}})}catch(e){console.error("Error in setupTriggers:",e)}return()=>{n.forEach(e=>e()),n.clear()}}function g(i,e,a){e.forEach(([t,r])=>{let n=JSON.parse(t);if("click"===n.type&&w(n))if("css"===n.clickType){t=n.clickValue.trim().split(/\s+/).map(e=>e.startsWith("#")?"#"+CSS.escape(e.slice(1)):e.startsWith(".")?"."+CSS.escape(e.slice(1)):"."+CSS.escape(e)).join("");try{if(i.matches(t)&&!s.has(i)){let e=()=>d(r);i.addEventListener("click",e),s.set(i,!0),console.log("Click trigger set for "+n.clickValue),a.set(i,()=>{i.removeEventListener("click",e),s.delete(i)})}}catch(e){console.error("Invalid selector: "+t,e)}}else"text"===n.clickType&&function(e){let t=[],r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),n;for(;n=r.nextNode();)t.push(n);return t}(i).forEach(e=>{if(e.textContent.trim()===n.clickValue){let t=e.parentElement;if(!s.has(t)){let e=e=>{e.target.textContent.trim()===n.clickValue&&d(r)};t.addEventListener("click",e),s.set(t,!0),a.set(t,()=>{t.removeEventListener("click",e),s.delete(t)})}}})})}"function"!=typeof CSS.escape&&(CSS.escape=function(e){return String(e).replace(/[\0-\x1F\x7F-\x9F\xA0\xAD\u0600-\u0604\u070F\u17B4\u17B5\u2000-\u200F\u2028-\u202F\u2060-\u206F\uFEFF\uFFF0-\uFFF8\uD800-\uF8FF\uFDD0-\uFDEF\uFFFE\uFFFF]/g,function(e){return"\\"+e.charCodeAt(0).toString(16)+" "}).replace(/[\s\S]/g,function(e){switch(e){case" ":case'"':case"#":case"$":case"%":case"&":case"'":case"(":case")":case"*":case"+":case",":case".":case"/":case";":case"<":case"=":case">":case"?":case"@":case"[":case"\\":case"]":case"^":case"`":case"{":case"|":case"}":case"~":return"\\"+e;default:return e}})}),async function(){var e=function(){var e;for(e of document.getElementsByTagName("script")){var t=e.src.match(/userId=([0-9a-fA-F]{24})/);if(t)return t[1]}return null}();if(!e)throw new Error("User ID is not provided in the URL");try{var r=await async function(e){try{var r=await fetch(u+`/api/appliedSurvey?userId=${e}&isDeploy=true`);if(!r.ok)throw new Error("Network response was not ok");var n=await r.json(),i=n.data.filter(c),a=await fetch(u+"/api/appliedSurvey/users/"+e);if(!a.ok)throw new Error("Network response was not ok");let t=(await a.json()).surveyPosition;return i.forEach(e=>{e.position=t}),{status:n.status,data:i}}catch(e){return console.error("Error fetching survey:",e),null}}(e);if(r){let t=i(r.data);window.addEventListener("beforeunload",()=>t(window.activeSurveyId)),window.addEventListener("surveyCompleted",function e(){t(window.activeSurveyId),window.removeEventListener("surveyCompleted",e)})}}catch(e){console.error("Error initializing survey script:",e)}}()}();